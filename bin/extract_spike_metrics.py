#!/usr/bin/env python

import json
import csv
import argparse
import pandas as pd
import h5py
import numpy as np

def argparse_setup():
    parser = argparse.ArgumentParser()
    parser.add_argument("-itrfp_json", help="XIC extraction in JSON format (e.g. generated by the ThermoRawFileParser)")
    parser.add_argument("-iidentifications", help="Identifications found for the sequences of teh spiek-ins")
    parser.add_argument("-ispikeins", help="The spike-ins (in CSV)")
    parser.add_argument("-ohdf5", help="The metrics where to save (outputs .hdf5)")

    return parser.parse_args()


def add_entry_to_hdf5(f, key: str, value, array_shape: tuple, data_type: str, unit: str, description: str, compression: str=None):
    """ Adds an entry into the hdf5 file """
    f.create_dataset(key, array_shape, dtype=data_type, compression=compression)
    f[key].attrs["unit"] = unit
    f[key].attrs["Description"] = description
    f[key].write_direct(np.array(value, dtype=data_type))


if __name__ == "__main__":
    args = argparse_setup()

    # load XICs
    with open(args.itrfp_json, "r") as trfp_in:
        xics = json.load(trfp_in)
    
    # load identifications
    identifications = dict()
    with open(args.iidentifications, "r") as ids_in:
        for l in ids_in:
            cols = l[:-1].split(",")
            identifications[cols[0]] = cols[1]
    
    # load spike_ins
    comment_to_data = dict()
    with open(args.ispikeins, "r") as in_csv_file:
        # Read spike-ins CSV and get header indicies
        csv_in = csv.reader(in_csv_file)
        header = next(csv_in)
        name_idx = header.index("name")
        seq_idx = header.index("sequence")
        mz_idx = header.index("mz")
        rt_idx = header.index("RT")

        # go line-wise through the spike-ins CSV
        for l in csv_in:
            # are there any identifications for this spike-in
            nr_ids = 0
            if str(l[seq_idx]) in identifications.keys():
                nr_ids = identifications[str(l[seq_idx])]

            # map from the comment to what we need
            comment_to_data[str(l[name_idx])] = {
                "maximum_int" : -1,
                "rt_at_maximum" : -1,
                "identifications" : nr_ids,
                "expected_rt": float(l[rt_idx]),
                "delta_rt": 0,
                "expected_mz": float(l[mz_idx])
            }

    # go through the extracted XICs and try to set the data (if XIC was successfully extracted)
    for xic in xics["Content"]:
        comment = str(xic["Meta"]["Comment"])
        if comment in comment_to_data.keys():

            rts = xic["RetentionTimes"]
            intensities = xic["Intensities"]

            # default value if no intensities are found
            max_int = 0
            max_int_rt = -1

            if intensities is not None and len(intensities) > 0:
                max_int = max(intensities)
                max_int_rt = rts[intensities.index(max_int)] * 60

            comment_to_data[comment]["rt_at_maximum"] = max_int_rt
            comment_to_data[comment]["maximum_int"] = max_int
            comment_to_data[comment]["delta_rt"] = max_int_rt - comment_to_data[comment]["expected_rt"]
    
    # prepare output
    with h5py.File(args.ohdf5, 'w') as out_h5:
        for comment, data in comment_to_data.items():
            spikeident = f"SPIKE_{comment}_MZ_{data['expected_mz']:.4f}_RT_{data['expected_rt']:.0f}"

            add_entry_to_hdf5(
                out_h5, f"{spikeident}_Maximum_Intensity", data['maximum_int'], (1,), "float64", "none", 
                description="The maximum intensity for this specific spikein."
            )
            add_entry_to_hdf5(
                out_h5, f"{spikeident}_RT_at_Maximum_Intensity", data['rt_at_maximum'], (1,), "float64", "seconds", 
                description="The retention time, where the maximum intensity for this specific spikein was."
            )
            add_entry_to_hdf5(
                out_h5, f"{spikeident}_PSMs", data['identifications'], (1,), "int32", "none", 
                description="Number of spectra identified with the respective spike-in peptide sequence."
            )
            add_entry_to_hdf5(
                out_h5, f"{spikeident}_Delta_to_expected_RT", data['delta_rt'], (1,), "float64", "seconds", 
                description="If peptide was identified: difference of expected and measured retention time for the first identified PSM."
            )
